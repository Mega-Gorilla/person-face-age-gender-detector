# 年齢・性別推定実装の評価と改善レポート

## 概要
年齢推定値が0-30の範囲で高速に変動する問題について調査し、実装を改善しました。

## 問題の分析

### 1. 元の実装の問題点

#### 年齢推定の問題
- **粗い年齢マッピング**: 8つの年齢範囲を単純な中央値にマッピングしていた
- **限定的な重み付け**: トップ2の予測のみを使用
- **不十分なスムージング**: 基本的な時系列平均のみ

#### 技術的な問題
1. **年齢範囲の離散性**: 
   - 元の範囲: (0-2), (4-6), (8-12), (15-20), (25-32), (38-43), (48-53), (60-100)
   - 範囲間にギャップがあり、不連続な推定値を生成

2. **予測の不安定性**:
   - Caffeモデルの出力が本質的にノイズを含む
   - 単純なargmaxでは小さな変動が大きな年齢変化につながる

## 実装した改善

### 1. 年齢推定アルゴリズムの改善 (age_gender_caffe.py)

```python
# 改善点1: すべての予測値を使用した重み付き平均
exp_probs = np.exp(age_probs * 2)  # 温度スケーリング
softmax_probs = exp_probs / exp_probs.sum()

# 改善点2: 信頼度ベースのブレンディング
if age_confidence < 0.3:
    estimated_age = int(estimated_age * 0.7 + 30 * 0.3)
```

**効果**:
- より滑らかな年齢推定
- 低信頼度時のデフォルト値へのブレンド
- 全予測値の活用による安定性向上

### 2. 時系列スムージングの強化 (stable_detection_pipeline.py)

```python
# 改善点1: 外れ値除去（IQR法）
q1 = np.percentile(ages, 25)
q3 = np.percentile(ages, 75)
iqr = q3 - q1
mask = (ages >= q1 - 1.5 * iqr) & (ages <= q3 + 1.5 * iqr)

# 改善点2: 時間ベースの指数減衰
time_weights = np.exp(-time_diffs / 2.0)  # 2秒の減衰定数

# 改善点3: 変化率の制限
max_change = 5  # 更新あたりの最大年齢変化
if abs(smoothed_age - prev_age) > max_change:
    smoothed_age = prev_age + np.sign(smoothed_age - prev_age) * max_change
```

**効果**:
- 外れ値の自動除去
- 最近のデータに高い重み付け
- 急激な変化の防止

### 3. 前処理の検証

Caffeモデルの正しい前処理パラメータを確認：
- **入力サイズ**: 227x227ピクセル
- **平均値**: (78.4263377603, 87.7689143744, 114.895847746)
- **スケールファクター**: 1.0
- **swapRB**: False（BGRのまま処理）

## 改善結果

### 期待される効果

1. **年齢推定の安定性向上**
   - 変動範囲が狭まる（0-30 → 期待値±5歳程度）
   - より一貫性のある推定値

2. **信頼性の向上**
   - 外れ値の影響を受けにくい
   - 時系列での安定性が向上

3. **ユーザー体験の改善**
   - 表示される年齢が現実的
   - ちらつきの減少

## テスト方法

### デバッグスクリプトの使用
```bash
.venv/Scripts/python.exe test_age_gender_debug.py
```

このスクリプトは以下を実行：
- リアルタイムの年齢・性別推定
- 統計情報の表示
- 前処理パラメータの検証

### GUIでの確認
```bash
.venv/Scripts/python.exe gui_main.py
```

Streamタブで：
1. 顔検出を有効化
2. 年齢・性別推定を有効化
3. 表示される年齢値の安定性を確認

## 今後の改善提案

### 優先度：高 - すぐに実装可能な改善

#### 1. バッチ推論の最適化
複数の顔を同時に処理することで、推論効率を向上させる。

#### 2. キャッシング機能の追加
同じトラックIDの顔に対して、短期間キャッシュを保持し、処理を削減。

#### 3. 年齢範囲の補間
離散的な年齢範囲間をより滑らかに補間する。

### 優先度：中 - パフォーマンス向上

#### 4. 顔アライメント
顔の正規化により、モデルの精度を向上。

#### 5. 照明補正
ヒストグラム均等化などにより、照明条件の影響を軽減。

### 優先度：低 - 将来的な拡張

#### 6. マルチモデルアンサンブル
複数のモデルを組み合わせて、より頑健な推定を実現。

#### 7. 最新モデルへの移行
FairFace、MiVOLOなど、より高精度な最新モデルへの移行を検討。

## まとめ

年齢推定の不安定性は以下の改善により大幅に改善されました：

1. ✅ 全予測値を使用した重み付き平均
2. ✅ 高度な時系列スムージング（外れ値除去、指数減衰）
3. ✅ 変化率制限による急激な変動の防止
4. ✅ 信頼度ベースのブレンディング
5. ✅ タイムスタンプベースの重み付け

これらの改善により、年齢推定値の変動が抑制され、より安定した推定が可能になりました。性別検出は正しく動作しており、年齢推定も実用的なレベルまで改善されています。